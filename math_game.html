<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factor Frenzy: 6, 7, 8 & 9</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f8ff; color: #333; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        input[type="text"], input[type="number"] { padding: 10px; font-size: 18px; width: 80%; margin-bottom: 20px; border: 2px solid #bdc3c7; border-radius: 8px; }
        button { padding: 10px 20px; font-size: 18px; background-color: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin: 5px; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .hidden { display: none; }
        #question-display { font-size: 48px; font-weight: bold; margin: 30px 0; color: #2c3e50; }
        #feedback { font-size: 20px; font-weight: bold; min-height: 24px; margin-bottom: 15px;}
        .correct { color: #f39c12; } 
        .incorrect { color: #e74c3c; }
        .star-display { font-size: 24px; font-weight: bold; color: #f39c12; margin: 15px 0; }
        
        #teacher-dashboard { text-align: left; max-width: 800px;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #3498db; color: white; }
        .error-log { font-size: 14px; color: #e74c3c; }
        #teacher-link { margin-top: 40px; display: inline-block; font-size: 14px; color: #95a5a6; cursor: pointer; text-decoration: underline; }
        
        .analytics-box { background: #fafafa; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px;}
        .chart-row { display: flex; align-items: center; margin-bottom: 12px; }
        .chart-label { width: 60px; font-weight: bold; color: #2c3e50;}
        .chart-bar-container { flex-grow: 1; background: #ecf0f1; height: 24px; border-radius: 12px; overflow: hidden; display: flex; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);}
        .chart-bar-correct { background: #27ae60; height: 100%; transition: width 0.5s; text-align: center; color: white; font-size: 12px; line-height: 24px; font-weight: bold;}
        .chart-bar-wrong { background: #e74c3c; height: 100%; transition: width 0.5s; text-align: center; color: white; font-size: 12px; line-height: 24px; font-weight: bold;}
        .weak-highlight { color: #e74c3c; font-weight: bold; font-size: 18px;}
    </style>
</head>
<body>

<div class="container" id="login-screen">
    <h1>Factor Frenzy ‚≠ê</h1>
    <p>Test your mental math for the 6, 7, 8, and 9 times tables!</p>
    <input type="text" id="student-name" placeholder="Enter your full name" required autocomplete="off">
    <br>
    <button onclick="startGame()">Start Game</button>
</div>

<div class="container hidden" id="game-screen">
    <h2>Question <span id="q-number">1</span> of 15</h2>
    <div class="star-display">Stars Earned: <span id="current-stars">0</span> ‚≠ê</div>
    <div id="question-display"></div>
    <div id="feedback"></div>
    <input type="number" id="answer-input" placeholder="Type answer & press Enter" autocomplete="off">
    <br>
    <button onclick="checkAnswer()">Submit</button>
</div>

<div class="container hidden" id="result-screen">
    <h1>Game Over! üéâ</h1>
    <h2 id="saving-status"><span id="final-name"></span>'s Results:</h2>
    <p>Time taken: <span id="final-time"></span> seconds</p>
    
    <div class="star-display">
        <p>Correct Answers: <span id="base-stars"></span> ‚≠ê</p>
        <p>Speed Bonus: <span id="bonus-stars"></span> ‚≠ê</p>
        <hr>
        <h3>Total Stars: <span id="total-stars"></span> ‚≠ê</h3>
    </div>
    
    <button onclick="resetToLogin()">Play Again</button>
</div>

<div class="container hidden" id="teacher-dashboard">
    <h1>Teacher Dashboard üìã</h1>
    <button onclick="closeTeacherDashboard()">Back to Game</button>
    <button onclick="clearData()" id="clear-btn" style="background-color: #e74c3c;">Clear All Data</button>
    
    <div class="analytics-box" id="analytics-section">
        <h2>Class Analytics üìä</h2>
        <p>Target Area (Weakest Times Table): <span id="weakest-table" class="weak-highlight">Loading...</span></p>
        <div id="bar-chart"></div>
        <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">*Green shows correct answers (‚úî), Red shows incorrect answers (‚úñ).</p>
    </div>

    <table id="results-table">
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Correct</th>
                <th>Time (s)</th>
                <th>Stars ‚≠ê</th>
                <th>Errors Made</th>
            </tr>
        </thead>
        <tbody id="results-body">
        </tbody>
    </table>
</div>

<div id="teacher-link" onclick="promptTeacher()">Teacher Dashboard</div>

<script>
    // ==========================================
    // TEACHER: PASTE YOUR GOOGLE SCRIPT URL BELOW
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwtCLRqwXscCZHZ821x3zoE9gjsyu-RPaSyosCBPhZAaGw8sESXONy_UCo4FjJDRyUi/exec"; 
    // ==========================================

    const totalQuestions = 15;
    let currentQuestion = 0, stars = 0, currentAnswer = 0, currentTableInPlay = 0;
    let studentName = "", startTime, endTime, errors = [], sessionStats = {}, audioCtx;

    const loginScreen = document.getElementById('login-screen');
    const gameScreen = document.getElementById('game-screen');
    const resultScreen = document.getElementById('result-screen');
    const dashboard = document.getElementById('teacher-dashboard');
    const questionDisplay = document.getElementById('question-display');
    const answerInput = document.getElementById('answer-input');
    const feedbackText = document.getElementById('feedback');
    const teacherLink = document.getElementById('teacher-link');
    const currentStarsDisplay = document.getElementById('current-stars');

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(isCorrect) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (isCorrect) {
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1760, audioCtx.currentTime + 0.1); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        } else {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    answerInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") { event.preventDefault(); checkAnswer(); }
    });

    function generateQuestion() {
        const tables = [6, 7, 8, 9];
        currentTableInPlay = tables[Math.floor(Math.random() * tables.length)]; 
        const otherNumber = Math.floor(Math.random() * 10) + 1; 
        const product = currentTableInPlay * otherNumber;
        const qType = Math.floor(Math.random() * 4); 
        
        if (qType === 0) { currentAnswer = product; return `${currentTableInPlay} √ó ${otherNumber} = ___`; } 
        else if (qType === 1) { currentAnswer = otherNumber; return `${currentTableInPlay} √ó ___ = ${product}`; } 
        else if (qType === 2) { currentAnswer = otherNumber; return `${product} √∑ ${currentTableInPlay} = ___`; } 
        else { currentAnswer = currentTableInPlay; return `${product} √∑ ___ = ${otherNumber}`; }
    }

    function startGame() {
        const nameInput = document.getElementById('student-name').value.trim();
        if (nameInput === "") { alert("Please enter your name first!"); return; }
        
        initAudio(); 
        studentName = nameInput; stars = 0; currentQuestion = 0; errors = [];
        sessionStats = { 6: {c:0, w:0}, 7: {c:0, w:0}, 8: {c:0, w:0}, 9: {c:0, w:0} };
        currentStarsDisplay.innerText = stars;
        startTime = new Date();
        
        document.getElementById('student-name').value = '';
        loginScreen.classList.add('hidden'); teacherLink.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        nextQuestion();
    }

    function nextQuestion() {
        currentQuestion++;
        if (currentQuestion > totalQuestions) { endGame(); return; }
        document.getElementById('q-number').innerText = currentQuestion;
        answerInput.value = ''; answerInput.focus(); feedbackText.innerText = '';
        questionDisplay.innerText = generateQuestion();
    }

    function checkAnswer() {
        if (answerInput.value === "") return;
        const studentAnswer = parseInt(answerInput.value);
        const qText = questionDisplay.innerText;
        const correctedText = qText.replace('___', currentAnswer);

        if (studentAnswer === currentAnswer) {
            playSound(true); stars++; currentStarsDisplay.innerText = stars;
            sessionStats[currentTableInPlay].c += 1; 
            feedbackText.innerText = "+1 ‚≠ê Correct!"; feedbackText.className = "correct";
            setTimeout(nextQuestion, 600);
        } else {
            playSound(false); sessionStats[currentTableInPlay].w += 1; 
            feedbackText.innerText = `Oops! No star. ${correctedText}`; feedbackText.className = "incorrect";
            errors.push(`${qText} (Answered: ${studentAnswer}, Correct: ${currentAnswer})`);
            setTimeout(nextQuestion, 1800); 
        }
    }

    function endGame() {
        endTime = new Date();
        const timeTaken = Math.round((endTime - startTime) / 1000);
        let timeBonus = timeTaken <= 60 ? 3 : (timeTaken <= 120 ? 2 : 1);
        const totalStars = stars + timeBonus;
        
        gameScreen.classList.add('hidden'); resultScreen.classList.remove('hidden'); teacherLink.classList.remove('hidden');
        
        document.getElementById('final-time').innerText = timeTaken;
        document.getElementById('base-stars').innerText = stars;
        document.getElementById('bonus-stars').innerText = timeBonus;
        document.getElementById('total-stars').innerText = totalStars;
        
        saveData(studentName, stars, timeTaken, totalStars, errors, sessionStats);
    }

    function resetToLogin() {
        resultScreen.classList.add('hidden'); loginScreen.classList.remove('hidden');
    }

    function saveData(name, score, time, totalStars, errorsArray, stats) {
        if (SCRIPT_URL === "PASTE_YOUR_WEB_APP_URL_HERE") {
            document.getElementById('saving-status').innerText = name + "'s Results (Not saved to Cloud - Missing Link)";
            return;
        }

        document.getElementById('saving-status').innerText = "Saving your score to the teacher's dashboard... ‚è≥";
        
        const date = new Date().toLocaleString();
        const errorsStr = errorsArray.join(" | ") || "None";
        const statsStr = JSON.stringify(stats);

        const url = `${SCRIPT_URL}?action=save&name=${encodeURIComponent(name)}&score=${score}&time=${time}&totalStars=${totalStars}&errors=${encodeURIComponent(errorsStr)}&date=${encodeURIComponent(date)}&stats=${encodeURIComponent(statsStr)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById('saving-status').innerText = name + "'s Results: Saved! ‚úÖ";
            })
            .catch(error => {
                document.getElementById('saving-status').innerText = "Score saved locally. (Connection error)";
            });
    }

    function promptTeacher() {
        const pass = prompt("Enter Teacher Password:");
        if (pass === "teacher123") showDashboard();
        else if (pass !== null) alert("Incorrect password.");
    }

    function showDashboard() {
        loginScreen.classList.add('hidden'); resultScreen.classList.add('hidden');
        teacherLink.classList.add('hidden'); dashboard.classList.remove('hidden');
        const tbody = document.getElementById('results-body');
        
        if (SCRIPT_URL === "PASTE_YOUR_WEB_APP_URL_HERE") {
            tbody.innerHTML = '<tr><td colspan="5">Google Link Missing! Add it to the code.</td></tr>';
            return;
        }

        tbody.innerHTML = '<tr><td colspan="5">Loading data from Google Sheets... ‚è≥</td></tr>';

        fetch(SCRIPT_URL + "?action=get")
            .then(res => res.json())
            .then(rows => {
                tbody.innerHTML = '';
                let globalStats = {6: {c:0, w:0}, 7: {c:0, w:0}, 8: {c:0, w:0}, 9: {c:0, w:0}};
                
                if (rows.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="5">No student data yet!</td></tr>';
                     document.getElementById('weakest-table').innerText = "Not enough data yet";
                     document.getElementById('bar-chart').innerHTML = "";
                     return;
                }

                rows.forEach(row => {
                    if (!row[0]) return; 
                    let [name, score, time, tStars, errs, date, statsRaw] = row;
                    
                    let tr = `<tr>
                        <td><strong>${name}</strong><br><small>${date}</small></td>
                        <td>${score}/15</td>
                        <td>${time}</td>
                        <td><strong>${tStars}</strong></td>
                        <td class="error-log">${errs === 'None' ? 'None! üåü' : errs}</td>
                    </tr>`;
                    tbody.innerHTML += tr;

                    try {
                        let parsed = JSON.parse(statsRaw);
                        [6, 7, 8, 9].forEach(t => { globalStats[t].c += parsed[t].c; globalStats[t].w += parsed[t].w; });
                    } catch(e) {}
                });

                updateChart(globalStats);
            });
    }

    function updateChart(globalStats) {
        let chartHTML = ""; let weakestTable = "Not enough data yet"; let highestErrorRate = -1; let totalQs = 0;

        [6, 7, 8, 9].forEach(table => {
            let data = globalStats[table]; let total = data.c + data.w; totalQs += total;
            let correctPct = total === 0 ? 0 : Math.round((data.c / total) * 100);
            let wrongPct = total === 0 ? 0 : 100 - correctPct;

            if (total > 0 && wrongPct > highestErrorRate) {
                highestErrorRate = wrongPct; weakestTable = `${table}s (${wrongPct}% Error Rate)`;
            }

            chartHTML += `
            <div class="chart-row">
                <div class="chart-label">${table}s</div>
                <div class="chart-bar-container">
                    <div class="chart-bar-correct" style="width: ${correctPct}%">${data.c > 0 ? data.c + ' ‚úî' : ''}</div>
                    <div class="chart-bar-wrong" style="width: ${wrongPct}%">${data.w > 0 ? data.w + ' ‚úñ' : ''}</div>
                </div>
            </div>`;
        });

        if (totalQs > 0 && highestErrorRate === 0) weakestTable = "None! The class has a perfect score so far! üåü";
        document.getElementById('weakest-table').innerText = weakestTable;
        document.getElementById('bar-chart').innerHTML = chartHTML;
    }

    function closeTeacherDashboard() {
        dashboard.classList.add('hidden'); loginScreen.classList.remove('hidden'); teacherLink.classList.remove('hidden');
    }

    function clearData() {
        if (confirm("Are you sure? This will delete all rows from your Google Sheet.")) {
            document.getElementById('clear-btn').innerText = "Clearing...";
            fetch(SCRIPT_URL + "?action=clear").then(() => {
                document.getElementById('clear-btn').innerText = "Clear All Data";
                showDashboard();
            });
        }
    }
</script>

</body>
</html>